# Corrected Nginx config for conf.d/default.conf: Only upstream and server blocks (fit inside global http).
# Why fixed? Removed top-level 'events {}' and 'http {}'—these are already in main nginx.conf.
# Placement: This file is included INSIDE http {}, so directives like upstream/server are allowed here.
# Deep logic: Nginx merges configs hierarchically. Global: events (connections) + http (web). Site-specific (conf.d):
#   - upstream: Backend pools (your apps).
#   - server: Virtual hosts (routes by domain/port).
# For multi-apps: Add more upstream/server or location blocks—no rewrap needed.

upstream auto-sql {
    server auto-sql:8501;  # Internal pointer to your Streamlit container (same host).
                           # Why upstream? Groups backends (add more servers for load balancing later).
}

server {
    listen 80;             # Public HTTP door (browser/EC2 IP:80).
    server_name _;         # Wildcard: Matches any domain (use EC2 IP for now; change to yourdomain.com later).

    location / {           # Catches all URLs (e.g., http://ec2-ip/). For paths: /sql → add alias.
        proxy_pass http://auto-sql;  # Forwards to upstream (your app). Magic: Copies request/response.
                                     # Why http://? Nginx resolves 'auto-sql' to localhost:8501 internally.

        # Essential headers: Pass real client info (app "sees" original request, not Nginx).
        # Without: App logs wrong IP (localhost), breaks features like geo-blocking.
        proxy_set_header Host $host;                          # Original domain (e.g., ec2-ip.com).
        proxy_set_header X-Real-IP $remote_addr;              # Client's IP (for security/logs).
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # IP chain (proxies).
        proxy_set_header X-Forwarded-Proto $scheme;           # HTTP/HTTPS flag (for app redirects).

        # Streamlit tweaks: Real-time friendly (no delays in UI updates like charts/loading).
        # Why? Streamlit uses WebSockets/chunks; buffering would queue data (laggy on t3.micro).
        proxy_buffering off;
        proxy_request_buffering off;
        chunked_transfer_encoding on;  # Streams partial responses (efficient bandwidth).

        # WebSocket support for Streamlit's real-time (widgets/reruns).
        # Why? Streamlit uses WS on /stream path; Nginx must proxy the upgrade.
        # Deep logic: Browser sends HTTP request with Upgrade header → Nginx forwards → Streamlit accepts (returns 101 Switching Protocols) → Persistent WS tunnel.
        # Without: Upgrade blocked (400 Bad Request), interactions fail (indefinite load).
        proxy_http_version 1.1;  # Required for WS (HTTP/1.1+ supports upgrades; 1.0 doesn't).
        proxy_set_header Upgrade $http_upgrade;  # Passes browser's "Upgrade: websocket" header.
        proxy_set_header Connection "upgrade";   # Tells Streamlit to switch protocols (closes HTTP, opens WS).
        proxy_read_timeout 86400s;  # Long timeout for persistent WS (24h; default 60s too short—causes drops).

        # Timeouts: Guards against slow clients/apps (t3.micro CPU bursts ~5 min; prevents hangs).
        proxy_connect_timeout 60s;   # Time to connect to backend.
        proxy_send_timeout 60s;      # Time to send request.
        #proxy_read_timeout 60s;      # Time to read response (longer for interactive apps).
    }

    # Future multi-app example: Add another location (no new server needed).
    # location /other-app {
    #     upstream other { server localhost:3000; }  # Define upstream here or above.
    #     proxy_pass http://other;
    #     # Copy headers/timeouts from above.
    # }
}